<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Rapport RAG - {{ (metriques.hit_rate * 100) | round(0) }}%</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        /* Styles inclus depuis le fichier CSS */
        {% include 'rapport_evaluation.css' %}
        
        /* Dynamic colors from backend */
        .header { background: linear-gradient(135deg, {{ color1 }} 0%, {{ color2 }} 100%); }
        .interpretation { border-left: 6px solid {{ color1 }}; }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div id="loading-overlay">
        <div class="spinner"></div>
        <p class="loading-text">üîÑ √âvaluation en cours...</p>
        <p style="color: #6b7280; font-size: 0.9rem; margin-top: 10px;">Cela peut prendre de 15 secondes √† plusieurs minutes.</p>
    </div>

    <div class="container">
        <div class="header">
            <h1>{{ (metriques.hit_rate * 100) | round(0) }}%</h1>
            <p>Taux de Succ√®s Global (Hit Rate)</p>
        </div>

        <div class="content">
            <!-- Interpretation -->
            <div class="interpretation">
                <h2>{{ interpretation_text | safe }}</h2>
                <p>Analyse bas√©e sur {{ metriques.nb_questions_testees }} questions de test.</p>
                {% if gain_text %}
                <p class="gain">{{ gain_text | safe }}</p>
                {% endif %}
            </div>

            <!-- KPIs principaux -->
            <div class="kpi-grid">
                <div class="kpi-card">
                    <span class="kpi-value">{{ metriques.nb_questions_testees }}</span>
                    <span class="kpi-label">Questions</span>
                </div>
                <div class="kpi-card">
                    <span class="kpi-value">{{ metriques.temps_moyen_ms | round(0) }} ms</span>
                    <span class="kpi-label">Latence Moy.</span>
                </div>
                <div class="kpi-card">
                    <span class="kpi-value">{{ (metriques.moyenne_confiance * 100) | round(1) }}%</span>
                    <span class="kpi-label">Confiance Moy.</span>
                </div>
                <div class="kpi-card">
                    <span class="kpi-value">{{ metriques.temps_total_s | round(1) }} s</span>
                    <span class="kpi-label">Dur√©e Total</span>
                </div>
            </div>

            <!-- Distribution de confiance -->
            <div class="section">
                <h3 class="section-title">üìä Distribution de la Confiance IA</h3>
                <div class="distribution-bar">
                    <div class="distribution-segment distribution-high" style="width: {{ (metriques.confiance_haute * 100) | round(1) }}%;">
                        {{ (metriques.confiance_haute * 100) | round(0) }}% Haute (‚â•80%)
                    </div>
                    <div class="distribution-segment distribution-medium" style="width: {{ (metriques.confiance_moyenne * 100) | round(1) }}%;">
                        {{ (metriques.confiance_moyenne * 100) | round(0) }}% Moyenne
                    </div>
                    <div class="distribution-segment distribution-low" style="width: {{ (metriques.confiance_faible * 100) | round(1) }}%;">
                        {{ (metriques.confiance_faible * 100) | round(0) }}% Faible (<65%)
                    </div>
                </div>
            </div>

            <!-- M√©triques avanc√©es -->
            <div class="section">
                <h3 class="section-title">üìà M√©triques Avanc√©es</h3>
                <div class="kpi-grid">
                    <div class="kpi-card">
                        <span class="kpi-value">{{ metriques.mrr | round(3) }}</span>
                        <span class="kpi-label">MRR</span>
                        <span class="kpi-sublabel">Rang R√©ciproque Moyen</span>
                    </div>
                    <div class="kpi-card">
                        <span class="kpi-value">{{ metriques.temps_p50_ms | round(0) }} ms</span>
                        <span class="kpi-label">P50 (M√©diane)</span>
                        <span class="kpi-sublabel">50% des requ√™tes</span>
                    </div>
                    <div class="kpi-card">
                        <span class="kpi-value">{{ metriques.temps_p95_ms | round(0) }} ms</span>
                        <span class="kpi-label">P95</span>
                        <span class="kpi-sublabel">95% des requ√™tes</span>
                    </div>
                    <div class="kpi-card">
                        <span class="kpi-value">{{ metriques.temps_p99_ms | round(0) }} ms</span>
                        <span class="kpi-label">P99</span>
                        <span class="kpi-sublabel">99% des requ√™tes</span>
                    </div>
                </div>
            </div>

            <!-- Tableau des r√©sultats (AVANT benchmarks) -->
            <div class="section">
                <h3 class="section-title">üîç D√©tail des requ√™tes (Top-K={{ metriques.k }})</h3>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th style="width: 60px; text-align: center;">ID</th>
                                <th>Question</th>
                                <th style="width: 120px; text-align: center;">R√©sultat</th>
                                <th style="width: 120px; text-align: center;">Confiance</th>
                                <th style="width: 100px; text-align: right;">Latence</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for r in resultats[:50] %}
                            <tr class="result-row {% if r.hit_rate > 0 %}row-success{% else %}row-error{% endif %}" data-reponse="{{ r.reponse | default('Pas de r√©ponse') }}">
                                <td class="cell-id"><strong>{{ r.id }}</strong></td>
                                <td class="cell-question">{{ r.question }}</td>
                                <td class="cell-result">
                                    {% if r.hit_rate > 0 %}
                                        <span class="badge-success">‚úÖ TROUV√â</span>
                                    {% else %}
                                        <span class="badge-error">‚ùå √âCHEC</span>
                                    {% endif %}
                                </td>
                                <td class="cell-confiance {% if r.score_confiance >= 0.8 %}color-success{% elif r.score_confiance >= 0.7 %}color-warning{% else %}color-danger{% endif %}">
                                    {{ (r.score_confiance * 100) | round(1) }}%
                                </td>
                                <td class="cell-latence {% if r.temps_ms < 1000 %}color-success{% elif r.temps_ms < 2000 %}color-warning{% else %}color-danger{% endif %}">
                                    {{ r.temps_ms }} ms
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Analyse des √©checs (AVANT benchmarks) -->
            {% set echecs = resultats | selectattr("hit_rate", "equalto", 0) | list %}
            {% if echecs %}
            <div class="section">
                <h3 class="section-title">‚ö†Ô∏è Questions Difficiles (Analyse des √âchecs)</h3>
                {% for r in echecs[:5] %}
                <div class="failure-card">
                    <div class="failure-card-title">Question {{ r.id }}: {{ r.question }}</div>
                    <div class="failure-card-details">Confiance: {{ (r.score_confiance * 100) | round(1) }}% - Latence: {{ r.temps_ms }}ms</div>
                </div>
                {% endfor %}
            </div>
            {% endif %}

            <!-- Graphique benchmark (APR√àS les requ√™tes) -->
            <div class="section">
                <h3 class="section-title">üìä Comparaison avec les Benchmarks Acad√©miques</h3>
                <div class="chart-container" style="height: 450px;">
                    <canvas id="benchmarkChart"></canvas>
                </div>
                <!-- Sources des benchmarks -->
                <div class="sources-box">
                    <h4>üìö Sources des benchmarks acad√©miques</h4>
                    <ul>
                        <li><strong>MS MARCO Passage Ranking</strong> : MRR@10 officiel du leaderboard Microsoft (BERT baseline ~0.365, SOTA ~0.45). <a href="https://microsoft.github.io/MSMARCO-Passage-Ranking-Submissions/leaderboard/" target="_blank">Leaderboard officiel</a></li>
                        <li><strong>SQuAD 2.0</strong> : F1 Score et Exact Match du leaderboard Stanford (Human F1: 89.45%, SOTA F1: ~93%). <a href="https://rajpurkar.github.io/SQuAD-explorer/" target="_blank">SQuAD Explorer</a></li>
                        <li><strong>BM25 Baseline</strong> : R√©f√©rence traditionnelle sans apprentissage profond (MRR ~0.19 sur MS MARCO). <a href="https://arxiv.org/abs/1904.08375" target="_blank">Nogueira et al. 2019</a></li>
                        <li><strong>DPR (Dense Passage Retrieval)</strong> : M√©thode de retrieval dense par Facebook AI. <a href="https://arxiv.org/abs/2004.04906" target="_blank">Karpukhin et al. 2020</a></li>
                    </ul>
                    <p class="note">Note : Les m√©triques varient selon la t√¢che (retrieval vs QA) et le dataset. Notre syst√®me utilise un Hit Rate @K pour mesurer si le document pertinent appara√Æt dans les K premiers r√©sultats.</p>
                </div>
            </div>

            <!-- Recommandations -->
            <div class="section">
                <h3 class="section-title">üí° Recommandations d'Am√©lioration</h3>
                <div class="info-box info-box-warning">
                    <ul>
                        {{ recommandations_html | safe }}
                    </ul>
                </div>
            </div>

            <!-- M√©thodologie -->
            <div class="section">
                <h3 class="section-title">üî¨ M√©thodologie d'√âvaluation</h3>
                <div class="info-box info-box-info">
                    <p style="margin: 0 0 15px 0; color: #1f2937; line-height: 1.6;">
                        <strong>Protocole de test :</strong> √âvaluation syst√©matique de {{ metriques.nb_questions_testees }} questions
                        issues de la base de connaissances, avec un d√©lai de 0.5s entre chaque requ√™te.
                    </p>
                    <p style="margin: 0 0 15px 0; color: #1f2937; line-height: 1.6;">
                        <strong>M√©triques utilis√©es :</strong>
                    </p>
                    <ul style="color: #4b5563;">
                        <li><strong>Hit Rate @{{ metriques.k }}</strong> : Pourcentage de requ√™tes ayant au moins 1 document pertinent dans les {{ metriques.k }} premiers r√©sultats</li>
                        <li><strong>MRR (Mean Reciprocal Rank)</strong> : M√©trique acad√©mique mesurant la position moyenne du 1er r√©sultat pertinent</li>
                        <li><strong>Confiance IA</strong> : Score de similarit√© cosinus des embeddings (0-1)</li>
                        <li><strong>Latence (P50/P95/P99)</strong> : Distribution des temps de r√©ponse (percentiles)</li>
                    </ul>
                    <p style="margin: 15px 0 0 0; color: #1f2937; line-height: 1.6;">
                        <strong>Technologie :</strong> Architecture RAG (Retrieval-Augmented Generation) avec FAISS pour la recherche vectorielle
                        et Mistral pour la g√©n√©ration de r√©ponses.
                    </p>
                </div>
            </div>

            <!-- Actions -->
            <div class="section">
                <h3 class="section-title" style="text-align: center;">‚öôÔ∏è Actions</h3>

                <!-- Relancer l'√©valuation avec choix -->
                <div class="form-container form-container-primary">
                    <h4 class="form-title">üîÑ Relancer une nouvelle √©valuation</h4>
                    <form id="eval-form" method="get" action="/api/v1/admin/evaluation" class="form-row">
                        <label class="form-label">
                            Nombre de questions :
                            <select id="sample-select" name="sample" class="form-select" onchange="document.getElementById('sample-custom').value=''; document.getElementById('sample-custom').removeAttribute('name');">
                                <option value="10">10 questions (rapide ~15s)</option>
                                <option value="20" selected>20 questions (standard ~30s)</option>
                                <option value="50">50 questions (complet ~1m30s)</option>
                                <option value="100">100 questions (exhaustif ~3min)</option>
                                <option value="0">Toutes les questions</option>
                            </select>
                        </label>
                        <label class="form-label">
                            ou nombre personnalis√© :
                            <input type="number" id="sample-custom" min="1" placeholder="ex: 30" class="form-input"
                                onchange="if(this.value) { this.setAttribute('name', 'sample'); document.getElementById('sample-select').removeAttribute('name'); } else { this.removeAttribute('name'); document.getElementById('sample-select').setAttribute('name', 'sample'); }"
                                oninput="if(this.value) { this.setAttribute('name', 'sample'); document.getElementById('sample-select').removeAttribute('name'); } else { this.removeAttribute('name'); document.getElementById('sample-select').setAttribute('name', 'sample'); }">
                        </label>
                        <button type="submit" class="btn btn-primary">
                            üîÑ Lancer l'√©valuation
                        </button>
                    </form>
                </div>

                <!-- Exports avec avertissement -->
                <div class="form-container form-container-warning">
                    <h4 class="form-title">üì¶ Exporter les r√©sultats</h4>
                    <div class="form-warning">
                        <p>
                            ‚ö†Ô∏è <strong>Information importante :</strong> Les exports recr√©ent une nouvelle √©valuation compl√®te
                            ({{ metriques.nb_questions_testees }} questions). Cela peut prendre <strong>30 secondes √† plusieurs minutes</strong>
                            selon le nombre de questions. Le t√©l√©chargement d√©marrera automatiquement une fois l'√©valuation termin√©e.
                        </p>
                    </div>
                    <div class="btn-row">
                        <a href="/api/v1/admin/evaluation/export?format_export=html&sample={{ metriques.nb_questions_testees }}" class="btn btn-purple" download>üìÑ Exporter HTML</a>
                        <a href="/api/v1/admin/evaluation/export?format_export=json&sample={{ metriques.nb_questions_testees }}" class="btn btn-green" download>üì• Exporter JSON</a>
                        <a href="/api/v1/admin/evaluation/export?format_export=csv&sample={{ metriques.nb_questions_testees }}" class="btn btn-teal" download>üìä Exporter CSV</a>
                    </div>
                </div>
            </div>

            <!-- Footer -->
            <div class="footer">
                <p class="footer-timestamp">G√©n√©r√© le {{ timestamp }}</p>
                <p class="footer-version">Mila-Assist - Syst√®me RAG v1.0 | Architecture 4 Containers</p>
            </div>
        </div>
    </div>

    <script>
        // Loading overlay lors de la soumission
        document.addEventListener('DOMContentLoaded', function() {
            const forms = document.querySelectorAll('form');
            forms.forEach(form => {
                form.addEventListener('submit', function(e) {
                    document.getElementById('loading-overlay').classList.add('active');
                });
            });
            
            // Gestion des tooltips avec positionnement dynamique
            const rows = document.querySelectorAll('.result-row');
            rows.forEach(row => {
                row.addEventListener('mouseenter', function(e) {
                    // Calculer la position du tooltip
                    const rect = this.getBoundingClientRect();
                    const viewportWidth = window.innerWidth;
                    const viewportHeight = window.innerHeight;
                    
                    // Positionner au-dessus de la ligne, centr√©
                    let top = rect.top - 10;
                    let left = rect.left + (rect.width / 2);
                    
                    // Ajuster si trop haut (afficher en dessous)
                    if (top < 200) {
                        top = rect.bottom + 10;
                        this.style.setProperty('--tooltip-top', top + 'px');
                    } else {
                        this.style.setProperty('--tooltip-top', (top - 150) + 'px');
                    }
                    
                    // Centrer horizontalement avec limites
                    left = Math.max(260, Math.min(left, viewportWidth - 260));
                    this.style.setProperty('--tooltip-left', left + 'px');
                });
            });
        });

        // Graphique de comparaison avec les benchmarks
        const ctx = document.getElementById('benchmarkChart').getContext('2d');
        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: {{ chart_labels | tojson }},
                datasets: [
                    {
                        label: 'Hit Rate (%)',
                        data: {{ chart_hit_rates | tojson }},
                        backgroundColor: 'rgba(59, 130, 246, 0.7)',
                        borderRadius: 6
                    },
                    {
                        label: 'MRR (%)',
                        data: {{ chart_mrrs | tojson }},
                        backgroundColor: 'rgba(16, 185, 129, 0.7)',
                        borderRadius: 6
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'top' },
                    title: {
                        display: true,
                        text: 'Performance vs Benchmarks Acad√©miques',
                        font: { size: 16, weight: 'bold', family: 'Inter' },
                        padding: 20
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 100,
                        ticks: {
                            callback: function(value) { return value + '%'; }
                        }
                    }
                }
            }
        });
    </script>
</body>
</html>
